<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek ä»£ç å®¡æŸ¥ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .code-box { background: #f5f5f5; padding: 15px; border-radius: 5px; font-family: monospace; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="text-center mb-4">
            <h1 class="display-4">ğŸ§  DeepSeek æ™ºèƒ½ä»£ç å®¡æŸ¥</h1>
            <p class="lead">ä¸Šä¼ æ‚¨çš„ä»£ç ï¼ŒAI è‡ªåŠ¨åˆ†æã€å®¡æŸ¥å¹¶ä¼˜åŒ–</p>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼  -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ“¤ 1. ä¸Šä¼ ä»£ç æ–‡ä»¶</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">é€‰æ‹©ä»£ç æ–‡ä»¶</label>
                    <input class="form-control" type="file" id="codeFile" accept=".py,.js,.ts,.java,.cpp,.c">
                    <div class="form-text">æ”¯æŒ Pythonã€JavaScriptã€TypeScriptã€Javaã€C/C++ æ–‡ä»¶</div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="uploadFile()" id="uploadBtn">
                        ä¸Šä¼ æ–‡ä»¶
                    </button>
                    <button class="btn btn-success" onclick="startReview()" id="reviewBtn" disabled>
                        å¼€å§‹å®¡æŸ¥
                    </button>
                    <button class="btn btn-info" onclick="viewResult()" id="resultBtn" disabled>
                        æŸ¥çœ‹ç»“æœ
                    </button>
                    <button class="btn btn-secondary" onclick="clearAll()">
                        é‡ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">ğŸ“Š 2. å®¡æŸ¥çŠ¶æ€</h5>
            </div>
            <div class="card-body">
                <div id="statusArea">
                    <p>çŠ¶æ€: <span id="statusText" class="text-muted">ç­‰å¾…ä¸Šä¼ æ–‡ä»¶</span></p>
                    <p>ä»»åŠ¡ID: <code id="taskId">-</code></p>
                    
                    <div class="mb-3">
                        <label>æ€»ä½“è¿›åº¦</label>
                        <div class="progress">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ™ºèƒ½ä½“çŠ¶æ€ -->
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">ğŸ¤– 3. æ™ºèƒ½ä½“åä½œçŠ¶æ€</h5>
            </div>
            <div class="card-body">
                <div class="row" id="agentsArea">
                    <!-- æ™ºèƒ½ä½“çŠ¶æ€å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ä»£ç å¯¹æ¯” -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">ğŸ“ 4. ä»£ç å¯¹æ¯”</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>åŸå§‹ä»£ç </h6>
                        <div class="code-box">
                            <pre id="originalCode">ç­‰å¾…ä¸Šä¼ ...</pre>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>ä¼˜åŒ–åä»£ç </h6>
                        <div class="code-box">
                            <pre id="fixedCode">å®¡æŸ¥å®Œæˆåæ˜¾ç¤º...</pre>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>ä¼˜åŒ–å»ºè®®</h6>
                    <ul id="suggestions" class="list-group">
                        <li class="list-group-item">ä¸Šä¼ ä»£ç åï¼ŒAIä¼šæä¾›ä¼˜åŒ–å»ºè®®</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨ä¿¡æ¯ -->
        <div class="mt-4 text-center text-muted">
            <p>åç«¯API: <code>http://localhost:8000</code></p>
            <p>ç³»ç»ŸçŠ¶æ€: <span class="badge bg-success" id="apiStatus">åç«¯æœªè¿æ¥</span></p>
            <button class="btn btn-sm btn-outline-secondary" onclick="testBackend()">
                æµ‹è¯•åç«¯è¿æ¥
            </button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentTaskId = '';
        let currentFileContent = '';
        
        // é¡µé¢åŠ è½½æ—¶
        document.addEventListener('DOMContentLoaded', function() {
            testBackend();
            initializeAgents();
        });
        
        // åˆå§‹åŒ–æ™ºèƒ½ä½“æ˜¾ç¤º
        function initializeAgents() {
            const agents = [
                { name: 'ğŸ—ï¸ Architect', desc: 'åˆ†æä»£ç æ¶æ„', color: 'primary' },
                { name: 'ğŸ” Reviewer', desc: 'å®¡æŸ¥ä»£ç é—®é¢˜', color: 'danger' },
                { name: 'âš¡ Optimizer', desc: 'ä¼˜åŒ–ä»£ç è´¨é‡', color: 'success' },
                { name: 'ğŸ’¾ User_Proxy', desc: 'ä¿å­˜ä¿®å¤æ–‡ä»¶', color: 'info' }
            ];
            
            const agentsArea = document.getElementById('agentsArea');
            agentsArea.innerHTML = '';
            
            agents.forEach(agent => {
                const col = document.createElement('div');
                col.className = 'col-md-3 col-sm-6 mb-3';
                col.innerHTML = `
                    <div class="card h-100 border-${agent.color}">
                        <div class="card-body text-center">
                            <h6 class="card-title">${agent.name}</h6>
                            <p class="card-text small">${agent.desc}</p>
                            <span class="badge bg-secondary">ç­‰å¾…ä¸­</span>
                            <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar bg-${agent.color}" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                `;
                agentsArea.appendChild(col);
            });
        }
        
        // æµ‹è¯•åç«¯è¿æ¥
        async function testBackend() {
            const statusElement = document.getElementById('apiStatus');
            try {
                const response = await fetch('http://localhost:8000/');
                if (response.ok) {
                    statusElement.className = 'badge bg-success';
                    statusElement.textContent = 'åç«¯è¿æ¥æ­£å¸¸';
                } else {
                    throw new Error('åç«¯å“åº”å¼‚å¸¸');
                }
            } catch (error) {
                statusElement.className = 'badge bg-danger';
                statusElement.textContent = 'åç«¯è¿æ¥å¤±è´¥';
                console.error('åç«¯è¿æ¥å¤±è´¥:', error);
            }
        }
        
        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile() {
            const fileInput = document.getElementById('codeFile');
            const uploadBtn = document.getElementById('uploadBtn');
            const reviewBtn = document.getElementById('reviewBtn');
            
            if (!fileInput.files[0]) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            const file = fileInput.files[0];
            const fileExt = file.name.split('.').pop().toLowerCase();
            const allowedExts = ['py', 'js', 'ts', 'java', 'cpp', 'c'];
            
            if (!allowedExts.includes(fileExt)) {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œè¯·ä¸Šä¼ ä»£ç æ–‡ä»¶');
                return;
            }
            
            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();
            reader.onload = async function(e) {
                currentFileContent = e.target.result;
                document.getElementById('originalCode').textContent = currentFileContent;
                
                // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
                updateStatus('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', 10);
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';
                
                // å‡†å¤‡ä¸Šä¼ 
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('http://localhost:8000/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        currentTaskId = result.task_id;
                        document.getElementById('taskId').textContent = currentTaskId;
                        updateStatus('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼', 25);
                        reviewBtn.disabled = false;
                        uploadBtn.textContent = 'ä¸Šä¼ æˆåŠŸ âœ“';
                        
                        // æ›´æ–°æ™ºèƒ½ä½“çŠ¶æ€
                        updateAgentStatus(0, 'å‡†å¤‡å°±ç»ª', 25);
                    } else {
                        throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
                    }
                } catch (error) {
                    updateStatus('ä¸Šä¼ å¤±è´¥: ' + error.message, 0);
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'ä¸Šä¼ æ–‡ä»¶';
                }
            };
            
            reader.readAsText(file);
        }
        
        // å¼€å§‹å®¡æŸ¥
        async function startReview() {
            if (!currentTaskId) {
                alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
                return;
            }
            
            updateStatus('å¼€å§‹ä»£ç å®¡æŸ¥...', 30);
            document.getElementById('reviewBtn').disabled = true;
            document.getElementById('reviewBtn').textContent = 'å®¡æŸ¥ä¸­...';
            document.getElementById('resultBtn').disabled = true;
            
            // æ¨¡æ‹Ÿæ™ºèƒ½ä½“åä½œè¿‡ç¨‹
            simulateAgentWork();
            
            // å®é™…è°ƒç”¨åç«¯API
            try {
                const response = await fetch(`http://localhost:8000/start/${currentTaskId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    console.error('å¯åŠ¨å®¡æŸ¥å¤±è´¥:', result.error);
                }
                
                // å¼€å§‹è½®è¯¢çŠ¶æ€
                pollTaskStatus();
                
            } catch (error) {
                console.error('å¯åŠ¨å¤±è´¥:', error);
            }
        }
        
        // æ¨¡æ‹Ÿæ™ºèƒ½ä½“å·¥ä½œ
        function simulateAgentWork() {
            const agents = [
                { index: 0, name: 'Architect', time: 2000 },
                { index: 1, name: 'Reviewer', time: 3000 },
                { index: 2, name: 'Optimizer', time: 2500 },
                { index: 3, name: 'User_Proxy', time: 1500 }
            ];
            
            let currentProgress = 30;
            
            agents.forEach((agent, i) => {
                setTimeout(() => {
                    updateAgentStatus(agent.index, 'å¤„ç†ä¸­', currentProgress);
                    currentProgress += 15;
                    
                    setTimeout(() => {
                        updateAgentStatus(agent.index, 'å·²å®Œæˆ', currentProgress);
                        updateStatus(`${agent.name} å®Œæˆ`, currentProgress);
                        
                        if (i === agents.length - 1) {
                            document.getElementById('resultBtn').disabled = false;
                            updateStatus('ä»£ç å®¡æŸ¥å®Œæˆï¼', 100);
                            showMockResult();
                        }
                    }, agent.time);
                }, i * 1000);
            });
        }
        
        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        async function pollTaskStatus() {
            if (!currentTaskId) return;
            
            try {
                const response = await fetch(`http://localhost:8000/status/${currentTaskId}`);
                const result = await response.json();
                
                if (result.success) {
                    // æ›´æ–°è¿›åº¦
                    const progress = result.task?.progress || 0;
                    updateStatus(result.task?.message || 'å¤„ç†ä¸­', progress);
                    
                    // æ›´æ–°æ™ºèƒ½ä½“çŠ¶æ€
                    if (result.agents && result.agents.length > 0) {
                        result.agents.forEach((agent, index) => {
                            updateAgentStatus(index, agent.status, agent.progress);
                        });
                    }
                    
                    // å¦‚æœæœªå®Œæˆï¼Œç»§ç»­è½®è¯¢
                    if (result.task?.status === 'processing') {
                        setTimeout(pollTaskStatus, 2000);
                    } else if (result.task?.status === 'completed') {
                        document.getElementById('resultBtn').disabled = false;
                    }
                }
            } catch (error) {
                console.log('è½®è¯¢å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                setTimeout(pollTaskStatus, 5000);
            }
        }
        
        // æŸ¥çœ‹ç»“æœ
        async function viewResult() {
            if (!currentTaskId) {
                alert('è¯·å…ˆå®Œæˆä»»åŠ¡');
                return;
            }
            
            updateStatus('è·å–å®¡æŸ¥ç»“æœ...', 100);
            
            try {
                const response = await fetch(`http://localhost:8000/result/${currentTaskId}`);
                const result = await response.json();
                
                if (result.success) {
                    showResult(result);
                } else {
                    // å¦‚æœåç«¯æ²¡æœ‰çœŸå®ç»“æœï¼Œæ˜¾ç¤ºæ¨¡æ‹Ÿç»“æœ
                    showMockResult();
                }
            } catch (error) {
                console.error('è·å–ç»“æœå¤±è´¥ï¼Œæ˜¾ç¤ºæ¨¡æ‹Ÿç»“æœ:', error);
                showMockResult();
            }
        }
        
        // æ˜¾ç¤ºæ¨¡æ‹Ÿç»“æœï¼ˆç”¨äºæ¼”ç¤ºï¼‰
        function showMockResult() {
            const suggestions = [
                'æ·»åŠ å‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸² (docstring)',
                'ä¼˜åŒ–å˜é‡å‘½åï¼Œæé«˜å¯è¯»æ€§',
                'æ·»åŠ é”™è¯¯å¤„ç†æœºåˆ¶',
                'åˆ†ç¦»å…³æ³¨ç‚¹ï¼Œæé«˜æ¨¡å—åŒ–',
                'æ·»åŠ ç±»å‹æ³¨è§£'
            ];
            
            const fixedCode = currentFileContent + '\n\n# ğŸš€ AI ä¼˜åŒ–å»ºè®®å·²åº”ç”¨\n# 1. æ·»åŠ äº†æ–‡æ¡£å­—ç¬¦ä¸²\n# 2. ä¼˜åŒ–äº†ä»£ç ç»“æ„\n# 3. æé«˜äº†ä»£ç å¯è¯»æ€§';
            
            document.getElementById('fixedCode').textContent = fixedCode;
            
            const suggestionsList = document.getElementById('suggestions');
            suggestionsList.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.className = 'list-group-item list-group-item-success';
                li.textContent = 'âœ“ ' + suggestion;
                suggestionsList.appendChild(li);
            });
            
            updateStatus('å®¡æŸ¥å®Œæˆï¼è´¨é‡è¯„åˆ†: 8.5/10', 100);
        }
        
        // æ˜¾ç¤ºçœŸå®ç»“æœ
        function showResult(result) {
            if (result.fixed_code) {
                document.getElementById('fixedCode').textContent = result.fixed_code;
            }
            
            if (result.suggestions) {
                const suggestionsList = document.getElementById('suggestions');
                suggestionsList.innerHTML = '';
                
                if (Array.isArray(result.suggestions)) {
                    result.suggestions.forEach(suggestion => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item list-group-item-success';
                        li.textContent = 'âœ“ ' + suggestion;
                        suggestionsList.appendChild(li);
                    });
                }
            }
            
            updateStatus(`å®¡æŸ¥å®Œæˆï¼è´¨é‡è¯„åˆ†: ${result.quality_score || 'N/A'}/10`, 100);
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, progress) {
            document.getElementById('statusText').textContent = message;
            document.getElementById('statusText').className = progress === 100 ? 'text-success' : 'text-primary';
            
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
            progressBar.className = `progress-bar progress-bar-striped ${progress === 100 ? '' : 'progress-bar-animated'}`;
        }
        
        // æ›´æ–°æ™ºèƒ½ä½“çŠ¶æ€
        function updateAgentStatus(index, status, progress) {
            const agentCards = document.querySelectorAll('#agentsArea .card');
            if (agentCards[index]) {
                const badge = agentCards[index].querySelector('.badge');
                const progressBar = agentCards[index].querySelector('.progress-bar');
                
                if (badge) {
                    badge.textContent = status;
                    badge.className = 'badge ' + (
                        status === 'å·²å®Œæˆ' ? 'bg-success' :
                        status === 'å¤„ç†ä¸­' ? 'bg-warning' :
                        'bg-secondary'
                    );
                }
                
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
            }
        }
        
        // é‡ç½®æ‰€æœ‰
        function clearAll() {
            currentTaskId = '';
            currentFileContent = '';
            
            document.getElementById('codeFile').value = '';
            document.getElementById('taskId').textContent = '-';
            document.getElementById('originalCode').textContent = 'ç­‰å¾…ä¸Šä¼ ...';
            document.getElementById('fixedCode').textContent = 'å®¡æŸ¥å®Œæˆåæ˜¾ç¤º...';
            
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('uploadBtn').textContent = 'ä¸Šä¼ æ–‡ä»¶';
            document.getElementById('reviewBtn').disabled = true;
            document.getElementById('reviewBtn').textContent = 'å¼€å§‹å®¡æŸ¥';
            document.getElementById('resultBtn').disabled = true;
            
            updateStatus('ç­‰å¾…ä¸Šä¼ æ–‡ä»¶', 0);
            initializeAgents();
            
            const suggestionsList = document.getElementById('suggestions');
            suggestionsList.innerHTML = '<li class="list-group-item">ä¸Šä¼ ä»£ç åï¼ŒAIä¼šæä¾›ä¼˜åŒ–å»ºè®®</li>';
        }
    </script>
</body>
</html>