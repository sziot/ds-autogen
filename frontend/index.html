<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek ä»£ç å®¡æŸ¥ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f8f9fa; }
        .card { margin-bottom: 20px; }
        .progress { height: 10px; }
        .agent-status { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">ğŸ§  DeepSeek ä»£ç å®¡æŸ¥ç³»ç»Ÿ</h1>
        
        <div id="root"></div>
        
        <!-- ä½¿ç”¨å†…è” Babel ç¼–è¯‘ JSX -->
        <script type="text/babel">
            const { useState, useEffect } = React;
            
            function App() {
                const [file, setFile] = useState(null);
                const [uploading, setUploading] = useState(false);
                const [taskId, setTaskId] = useState('');
                const [status, setStatus] = useState('ç­‰å¾…ä¸Šä¼ ');
                const [progress, setProgress] = useState(0);
                const [agents, setAgents] = useState([
                    { name: 'ğŸ—ï¸ Architect', status: 'ç­‰å¾…ä¸­', progress: 0 },
                    { name: 'ğŸ” Reviewer', status: 'ç­‰å¾…ä¸­', progress: 0 },
                    { name: 'âš¡ Optimizer', status: 'ç­‰å¾…ä¸­', progress: 0 },
                    { name: 'ğŸ’¾ User_Proxy', status: 'ç­‰å¾…ä¸­', progress: 0 }
                ]);
                
                // æ–‡ä»¶é€‰æ‹©å¤„ç†
                const handleFileSelect = (e) => {
                    const selectedFile = e.target.files[0];
                    if (selectedFile && selectedFile.name.endsWith('.py')) {
                        setFile(selectedFile);
                        setStatus('æ–‡ä»¶å·²é€‰æ‹©: ' + selectedFile.name);
                    } else {
                        alert('è¯·é€‰æ‹© .py æ–‡ä»¶');
                    }
                };
                
                // ä¸Šä¼ æ–‡ä»¶
                const uploadFile = async () => {
                    if (!file) {
                        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                        return;
                    }
                    
                    setUploading(true);
                    setStatus('ä¸Šä¼ ä¸­...');
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    try {
                        const response = await fetch('http://localhost:8000/api/v1/review', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            setTaskId(result.task_id);
                            setStatus('ä¸Šä¼ æˆåŠŸï¼ä»»åŠ¡ID: ' + result.task_id);
                            alert('ä¸Šä¼ æˆåŠŸï¼ç‚¹å‡»"å¼€å§‹å®¡æŸ¥"æŒ‰é’®è¿›è¡Œåˆ†æ');
                        } else {
                            throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
                        }
                    } catch (error) {
                        setStatus('ä¸Šä¼ å¤±è´¥: ' + error.message);
                        alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
                    } finally {
                        setUploading(false);
                    }
                };
                
                // å¼€å§‹å®¡æŸ¥
                const startReview = async () => {
                    if (!taskId) {
                        alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
                        return;
                    }
                    
                    setStatus('å¼€å§‹å®¡æŸ¥...');
                    setProgress(0);
                    
                    try {
                        const response = await fetch(`http://localhost:8000/start/${taskId}`, {
                            method: 'POST'
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            setStatus('å®¡æŸ¥å·²å¼€å§‹ï¼Œæ­£åœ¨å¤„ç†...');
                            // å¼€å§‹è½®è¯¢çŠ¶æ€
                            pollStatus();
                        } else {
                            throw new Error(result.error || 'å¯åŠ¨å¤±è´¥');
                        }
                    } catch (error) {
                        setStatus('å¯åŠ¨å¤±è´¥: ' + error.message);
                    }
                };
                
                // è½®è¯¢çŠ¶æ€
                const pollStatus = async () => {
                    if (!taskId) return;
                    
                    try {
                        const response = await fetch(`http://localhost:8000/status/${taskId}`);
                        const data = await response.json();
                        
                        if (data.success) {
                            setStatus(data.task?.message || 'å¤„ç†ä¸­');
                            setProgress(data.task?.progress || 0);
                            
                            // æ›´æ–°æ™ºèƒ½ä½“çŠ¶æ€
                            if (data.agents && data.agents.length > 0) {
                                setAgents(agents.map((agent, index) => ({
                                    ...agent,
                                    status: data.agents[index]?.status || 'ç­‰å¾…ä¸­',
                                    progress: data.agents[index]?.progress || 0
                                })));
                            }
                            
                            // å¦‚æœæœªå®Œæˆï¼Œç»§ç»­è½®è¯¢
                            if (data.task?.status === 'processing') {
                                setTimeout(pollStatus, 2000);
                            } else if (data.task?.status === 'completed') {
                                setStatus('å®¡æŸ¥å®Œæˆï¼');
                                alert('ä»£ç å®¡æŸ¥å®Œæˆï¼');
                            }
                        }
                    } catch (error) {
                        console.error('è½®è¯¢å¤±è´¥:', error);
                        setTimeout(pollStatus, 5000);
                    }
                };
                
                // æŸ¥çœ‹ç»“æœ
                const viewResult = async () => {
                    if (!taskId) {
                        alert('è¯·å…ˆå®Œæˆä»»åŠ¡');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`http://localhost:8000/result/${taskId}`);
                        const result = await response.json();
                        
                        if (result.success) {
                            const resultText = `
æ–‡ä»¶: ${result.file_name}
è¯„åˆ†: ${result.quality_score}/10
æ€»ç»“: ${result.summary}

åŸå§‹ä»£ç :
${result.original_code}

ä¿®å¤åä»£ç :
${result.fixed_code}

å»ºè®®:
${result.suggestions?.join('\nâ€¢ ')}
                            `;
                            alert(resultText);
                        } else {
                            alert('è·å–ç»“æœå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                        }
                    } catch (error) {
                        alert('è·å–ç»“æœå¤±è´¥: ' + error.message);
                    }
                };
                
                // æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
                const viewTasks = async () => {
                    try {
                        const response = await fetch('http://localhost:8000/tasks');
                        const result = await response.json();
                        
                        if (result.success) {
                            let tasksText = 'æ‰€æœ‰ä»»åŠ¡:\n\n';
                            result.tasks.forEach(task => {
                                tasksText += `ID: ${task.id}
æ–‡ä»¶: ${task.file_name}
çŠ¶æ€: ${task.status}
è¿›åº¦: ${task.progress}%
åˆ›å»ºæ—¶é—´: ${task.created_at}

`;
                            });
                            alert(tasksText || 'æš‚æ— ä»»åŠ¡');
                        }
                    } catch (error) {
                        console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
                    }
                };
                
                return (
                    <div>
                        {/* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */}
                        <div className="card">
                            <div className="card-body">
                                <h5 className="card-title">ğŸ“¤ ä¸Šä¼ ä»£ç æ–‡ä»¶</h5>
                                <div className="mb-3">
                                    <input 
                                        type="file" 
                                        className="form-control" 
                                        accept=".py,.js,.ts,.java"
                                        onChange={handleFileSelect}
                                        disabled={uploading}
                                    />
                                    <div className="form-text">
                                        æ”¯æŒ: .py .js .ts .java æ–‡ä»¶
                                    </div>
                                </div>
                                
                                <div className="d-flex gap-2">
                                    <button 
                                        className="btn btn-primary"
                                        onClick={uploadFile}
                                        disabled={!file || uploading}
                                    >
                                        {uploading ? 'ä¸Šä¼ ä¸­...' : 'ä¸Šä¼ æ–‡ä»¶'}
                                    </button>
                                    
                                    <button 
                                        className="btn btn-success"
                                        onClick={startReview}
                                        disabled={!taskId || progress > 0}
                                    >
                                        å¼€å§‹å®¡æŸ¥
                                    </button>
                                    
                                    <button 
                                        className="btn btn-info"
                                        onClick={viewResult}
                                        disabled={progress < 100}
                                    >
                                        æŸ¥çœ‹ç»“æœ
                                    </button>
                                    
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={viewTasks}
                                    >
                                        æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        {/* çŠ¶æ€æ˜¾ç¤º */}
                        <div className="card">
                            <div className="card-body">
                                <h5 className="card-title">ğŸ“Š å½“å‰çŠ¶æ€</h5>
                                <p className="card-text">
                                    <strong>çŠ¶æ€:</strong> {status}
                                </p>
                                
                                {taskId && (
                                    <p className="card-text">
                                        <strong>ä»»åŠ¡ID:</strong> <code>{taskId}</code>
                                    </p>
                                )}
                                
                                <div className="mb-3">
                                    <strong>è¿›åº¦:</strong>
                                    <div className="progress mt-2">
                                        <div 
                                            className="progress-bar progress-bar-striped progress-bar-animated" 
                                            style={{ width: `${progress}%` }}
                                        >
                                            {progress}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* æ™ºèƒ½ä½“çŠ¶æ€ */}
                        <div className="card">
                            <div className="card-body">
                                <h5 className="card-title">ğŸ¤– æ™ºèƒ½ä½“çŠ¶æ€</h5>
                                {agents.map((agent, index) => (
                                    <div key={index} className="agent-status">
                                        <div className="d-flex justify-content-between">
                                            <span>{agent.name}</span>
                                            <span className={`badge ${agent.status === 'completed' ? 'bg-success' : agent.status === 'processing' ? 'bg-warning' : 'bg-secondary'}`}>
                                                {agent.status}
                                            </span>
                                        </div>
                                        <div className="progress" style={{ height: '5px' }}>
                                            <div 
                                                className="progress-bar" 
                                                style={{ width: `${agent.progress}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* ç³»ç»Ÿä¿¡æ¯ */}
                        <div className="card">
                            <div className="card-body">
                                <h5 className="card-title">â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</h5>
                                <ul>
                                    <li>åç«¯API: http://localhost:8000</li>
                                    <li>æ— éœ€æ•°æ®åº“ï¼Œå†…å­˜å­˜å‚¨</li>
                                    <li>æ™ºèƒ½ä½“åä½œ: Architect â†’ Reviewer â†’ Optimizer</li>
                                    <li>è‡ªåŠ¨ä¿å­˜ä¿®å¤åçš„ä»£ç åˆ° fixed/ ç›®å½•</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // æ¸²æŸ“åº”ç”¨
            ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        </script>
    </div>
</body>
</html>